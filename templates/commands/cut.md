---
description: 智能视频剪辑 - 基于检测报告自动裁剪
scripts:
  sh: ../../scripts/bash/cut.sh
  ps1: ../../scripts/powershell/cut.ps1
---

# /cut - 智能视频剪辑

## AI 角色

你是一位**视频剪辑助手**。你的职责是:
1. **读取检测报告**理解剪辑点
2. **引导用户确认**展示将要执行的剪辑操作
3. **执行剪辑**调用 FFmpeg 处理视频
4. **生成剪辑后的视频**保存到 clips 目录

---

## 前置要求

⚠️ **必须先运行 `/detect` 命令生成检测报告!**

如果没有检测报告,会提示:
```
错误: 未找到检测报告
请先运行 /detect 命令进行视频检测
```

---

## 工作流程

### 步骤 0: 检查检测报告

运行脚本:
```bash
bash scripts/bash/cut.sh [--auto|--interactive]
```

脚本会:
1. 检查 `clips/detect-report.json` 是否存在
2. 读取检测到的片段信息
3. 生成剪辑计划

---

### 步骤 1: 剪辑模式选择(ABCDE)

**⚠️ 必须使用 ABCDE 选择模式!**

根据检测报告,展示剪辑选项:

#### A. ⚡ 自动剪辑模式 ⭐ 推荐

**说明**:
- 根据检测报告自动处理所有片段
- 删除所有静音片段
- 加速所有重复操作
- 一键完成,无需人工干预

**适用场景**:
- 检测结果准确
- 信任 AI 判断
- 追求效率

**执行命令**: `/cut --auto`

**预期效果**:
```
✓ 将删除 12 个静音片段 (节省 3分15秒)
✓ 将加速 5 个重复片段 (节省 45秒)
✓ 预计新视频时长: 26分00秒 (原 30分00秒)
✓ 处理时间: 约 2-3分钟
```

---

#### B. 🎯 交互式剪辑模式

**说明**:
- 逐个片段预览和确认
- 每个剪辑点都会询问用户
- 可以调整剪辑参数
- 完全掌控剪辑过程

**适用场景**:
- 首次使用,不确定效果
- 需要精细控制
- 部分片段需要保留

**执行命令**: `/cut --interactive`

**交互流程**:
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
片段 1/17: 静音片段
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  时间: 00:02:00 - 00:02:05 (5.3秒)
  类型: 静音
  建议: 删除

预览: [播放 5 秒音频片段]

请选择操作:
A. 删除此片段 ⭐ 推荐
B. 保留此片段
C. 加速 1.5x
D. 加速 2x
E. 跳过(稍后处理)

请选择 A/B/C/D/E:
```

---

#### C. 🔧 自定义剪辑模式

**说明**:
- 手动指定剪辑时间点
- 不依赖检测报告
- 完全自定义

**格式**:
```
00:01:30-00:03:45 delete    # 删除此片段
00:05:00-00:08:00 speed2x   # 加速 2x
00:10:00-00:12:00 keep      # 保留(标记精彩片段)
```

**示例**:
```
请输入剪辑指令(每行一条,输入 done 完成):
> 00:02:00-00:02:05 delete
> 00:05:30-00:05:40 speed2x
> 00:15:00-00:20:00 delete
> done

确认以上 3 条指令? (Y/n):
```

---

#### D. 📋 预览剪辑计划

**说明**:
- 不执行剪辑,只生成计划
- 查看将要执行的操作
- 估算处理时间和效果

**执行命令**: `/cut --preview`

**输出示例**:
```
╔═══════════════════════════════════════════════════╗
║          剪辑计划预览                              ║
╚═══════════════════════════════════════════════════╝

📋 将执行以下操作:

🔇 删除静音片段: 12 处
  1. 00:02:00 - 00:02:05 (5.3秒)
  2. 00:05:40 - 00:05:43 (2.8秒)
  ...

🔁 加速重复片段: 5 处
  1. 00:03:20 - 00:03:30 (10秒) → 加速 2x → 5秒
  2. 00:12:45 - 00:12:55 (10秒) → 加速 2x → 5秒
  ...

⏱️ 处理结果:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  原始时长:     30分00秒
  删除静音:     - 3分15秒
  加速重复:     - 0分45秒
  ──────────────────────────────────
  预计时长:     26分00秒
  节省时间:     4分00秒 (13.3%)

💾 剪辑文件将保存到: clips/edited-video.mp4
⏱️ 预计处理时间: 2-3分钟

确认执行? (Y/n):
```

---

#### E. 💭 取消剪辑

返回上一步,重新检测或调整参数。

---

### 步骤 2: 执行剪辑

根据用户选择,执行剪辑操作:

#### 自动模式流程

```
[1/4] 读取检测报告...           ✓ 完成
[2/4] 生成 FFmpeg 指令...       ✓ 完成
[3/4] 执行视频剪辑...           ⏳ 处理中 45%
      └─ 删除静音片段 8/12
      └─ 加速重复片段 3/5
[4/4] 保存剪辑结果...           等待中...
```

#### 交互模式流程

```
片段 1/17: 00:02:00-00:02:05 (静音)
  ✓ 已删除

片段 2/17: 00:03:20-00:03:30 (重复)
  ⏩ 已加速 2x

片段 3/17: 00:05:40-00:05:43 (静音)
  → 跳过(用户选择保留)

...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
处理完成!
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  处理片段: 17/17
  删除: 10 个
  加速: 5 个
  保留: 2 个
  处理时间: 2分34秒
```

---

### 步骤 3: 剪辑结果展示

```
╔═══════════════════════════════════════════════════╗
║          剪辑完成                                  ║
╚═══════════════════════════════════════════════════╝

✅ 剪辑成功!

📹 原始视频:
  文件: videos/lecture-2024-11-05.mp4
  时长: 30分00秒
  大小: 450 MB

✂️ 剪辑后视频:
  文件: clips/lecture-2024-11-05-edited.mp4
  时长: 26分00秒 ⬇️ 节省 4分钟 (13.3%)
  大小: 390 MB ⬇️ 减少 60 MB

📊 处理统计:
  删除片段: 12 处 (3分15秒)
  加速片段: 5 处 (1分30秒 → 45秒)
  保留片段: 原视频其余部分
  处理时间: 2分34秒

💾 文件位置:
  • 剪辑视频: clips/lecture-2024-11-05-edited.mp4
  • 剪辑日志: clips/cut-log.txt
  • 时间轴对照: clips/timeline-mapping.json
```

---

### 步骤 4: 下一步建议

根据剪辑结果,提供后续建议:

#### 如果剪辑效果满意
```
✅ 剪辑效果很好!

📋 接下来你可以:

1️⃣ 添加字幕
   运行命令: /transcribe
   使用阿里云语音识别自动生成字幕

2️⃣ 合并片段(如果有多段)
   运行命令: /merge
   将剪辑后的片段合并为一个文件

3️⃣ 直接导出
   运行命令: /export --preset youtube
   导出适合平台的成品视频

4️⃣ 预览剪辑结果
   使用播放器打开: clips/lecture-2024-11-05-edited.mp4
```

#### 如果需要调整
```
💡 如果剪辑效果不理想:

1️⃣ 重新检测(调整参数)
   运行命令: /detect --custom
   手动调整静音阈值、重复相似度等参数

2️⃣ 使用交互模式重新剪辑
   运行命令: /cut --interactive
   逐个确认每个片段

3️⃣ 自定义剪辑
   运行命令: /cut --custom
   手动指定要删除或加速的时间段
```

---

## 技术细节

### FFmpeg 剪辑原理

#### 删除片段
使用 FFmpeg 的 `select` 滤镜:
```bash
ffmpeg -i input.mp4 \
  -vf "select='not(between(t,120,125))',setpts=N/FRAME_RATE/TB" \
  -af "aselect='not(between(t,120,125))',asetpts=N/SR/TB" \
  output.mp4
```

#### 加速片段
使用 `setpts` 和 `atempo` 滤镜:
```bash
ffmpeg -i input.mp4 \
  -filter_complex "[0:v]setpts=0.5*PTS[v];[0:a]atempo=2.0[a]" \
  -map "[v]" -map "[a]" output.mp4
```

#### 复杂剪辑(多段)
生成剪辑指令文件,使用 `concat` 协议:
```bash
# 创建 filelist.txt
file 'segment1.mp4'
file 'segment2.mp4'
file 'segment3.mp4'

# 合并
ffmpeg -f concat -safe 0 -i filelist.txt -c copy output.mp4
```

---

## 剪辑选项

### --auto
自动剪辑,无需确认:
```bash
/cut --auto
```

### --interactive
交互式确认每个片段:
```bash
/cut --interactive
```

### --preview
预览剪辑计划,不执行:
```bash
/cut --preview
```

### --custom
自定义剪辑时间点:
```bash
/cut --custom
```

### --keep-original
保留原始视频:
```bash
/cut --auto --keep-original
```
默认情况下原视频不会被删除。

---

## 注意事项

### ⚠️ 处理时间

- 视频剪辑是 CPU 密集型操作
- 30分钟视频大约需要 2-5 分钟处理
- 使用 `--fast` 选项可启用快速模式(有损质量)

### 💾 磁盘空间

- 剪辑过程会生成临时文件
- 至少需要原视频 1-2 倍的剩余空间
- 完成后临时文件会自动清理

### 🎬 视频质量

- 默认使用无损剪辑 (`-c copy`)
- 如果需要重新编码,会略微降低质量
- 可通过 `--quality high` 提高质量(增加处理时间)

### 📂 文件位置

- 原始视频: `videos/`
- 剪辑后视频: `clips/`
- 临时文件: `clips/temp/`
- 日志文件: `clips/cut-log.txt`

---

## 故障排查

### 问题 1: FFmpeg 处理失败

如果遇到 FFmpeg 错误:
```
查看详细日志: clips/cut-log.txt
检查视频编码: ffprobe -i video.mp4
```

### 问题 2: 处理时间过长

如果处理超过预期时间:
- 使用 `--fast` 快速模式
- 减少要处理的片段数量
- 检查 CPU 使用率

### 问题 3: 音视频不同步

如果剪辑后音画不同步:
- 使用 `--resync` 选项重新同步
- 或重新编码: `--reencode`

---

## 高级用法

### 批量剪辑多个视频

```bash
/cut --batch videos/*.mp4
```

### 自定义输出格式

```bash
/cut --auto --format mp4 --codec h265
```

### 保留特定片段

```bash
/cut --auto --keep 00:10:00-00:12:00
```

这会删除所有检测到的片段,但保留 10-12 分钟的内容。
